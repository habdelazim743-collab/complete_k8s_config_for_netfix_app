apiVersion: batch/v1
kind: Job
metadata:
  name: keycloak-bootstrap-fix
  namespace: auth
spec:
  backoffLimit: 3
  template:
    spec:
      serviceAccountName: keycloak-bootstrap
      restartPolicy: Never
      containers:
      - name: bootstrap
        image: alpine:3.19
        command: ["sh", "-c"]
        args:
        - |
          set -e
          echo "Installing tools..."
          apk add --no-cache curl jq openssl
          
          echo "Installing kubectl..."
          curl -LO "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
          chmod +x kubectl
          mv kubectl /usr/local/bin/
          
          echo "Waiting for Keycloak..."
          until curl -sf http://keycloak:8080/realms/master; do
            echo "Keycloak not ready, retrying..."
            sleep 5
          done
          
          echo "Login to Keycloak"
          TOKEN=$(curl -s \
            -d "username=${KEYCLOAK_ADMIN}" \
            -d "password=${KEYCLOAK_ADMIN_PASSWORD}" \
            -d "grant_type=password" \
            -d "client_id=admin-cli" \
            http://keycloak:8080/realms/master/protocol/openid-connect/token \
            | jq -r .access_token)
          
          if [ "$TOKEN" = "null" ] || [ -z "$TOKEN" ]; then
            echo "❌ Failed to get admin token"
            exit 1
          fi
          echo "✅ Successfully authenticated"
          
          echo "Checking if oauth2-proxy client exists..."
          CLIENT_UUID=$(curl -s \
            -H "Authorization: Bearer $TOKEN" \
            http://keycloak:8080/admin/realms/master/clients \
            | jq -r '.[] | select(.clientId=="oauth2-proxy") | .id')
          
          if [ -n "$CLIENT_UUID" ]; then
            echo "✅ Client exists, updating redirect URIs..."
            curl -s -X PUT \
              -H "Authorization: Bearer $TOKEN" \
              -H "Content-Type: application/json" \
              http://keycloak:8080/admin/realms/master/clients/$CLIENT_UUID \
              -d '{
                "clientId": "oauth2-proxy",
                "enabled": true,
                "publicClient": false,
                "redirectUris": [
                  "https://netfix.habdelazim.xyz/oauth2/callback",
                  "https://netfix.habdelazim.xyz/*"
                ],
                "webOrigins": ["+"],
                "protocol": "openid-connect",
                "standardFlowEnabled": true,
                "directAccessGrantsEnabled": false
              }'
            echo "✅ Client updated with correct redirect URIs"
          else
            echo "Client doesn't exist, skipping..."
          fi
          
          echo "✅ Fix completed successfully"
        env:
        - name: KEYCLOAK_ADMIN
          valueFrom:
            secretKeyRef:
              name: keycloak-admin
              key: KEYCLOAK_ADMIN
        - name: KEYCLOAK_ADMIN_PASSWORD
          valueFrom:
            secretKeyRef:
              name: keycloak-admin
              key: KEYCLOAK_ADMIN_PASSWORD
